# =============================================================================
# MKINITCPIO CONFIGURATION - INITIAL RAMDISK GENERATION
# =============================================================================
# Author: merneo
# System: HP EliteBook x360 1030 G2 (Intel i5-7300U, LUKS2 encrypted root)
# Purpose: Configure the initial ramdisk (initramfs) generation for encrypted
#          boot with Plymouth splash screen and Intel GPU early initialization.
#
# File Location: /etc/mkinitcpio.conf
# After modifying, rebuild initramfs:
#   sudo mkinitcpio -P
#
# Initramfs Purpose:
#   The initramfs is a temporary root filesystem loaded by GRUB into RAM.
#   It contains kernel modules, binaries, and scripts needed to:
#   1. Initialize hardware (GPU, USB, storage controllers)
#   2. Decrypt LUKS-encrypted root partition
#   3. Display Plymouth boot splash during initialization
#   4. Mount the real root filesystem and pivot_root to it
#
# Boot Sequence (this system):
#   GRUB → Kernel + Initramfs → i915 GPU init → Plymouth splash →
#   LUKS decrypt (keyfile) → Btrfs mount → pivot_root → systemd → SDDM
# =============================================================================

# vim:set ft=sh:

# ===========================================================================
# MODULES - KERNEL MODULES LOADED EARLY IN BOOT
# ===========================================================================
# Modules listed here are loaded before any hooks run, ensuring hardware
# is initialized as early as possible.
#
# i915 (Intel HD Graphics 620):
#   - Kernel Mode Setting (KMS) driver for Intel integrated GPUs
#   - Required for Plymouth boot splash (framebuffer graphics)
#   - Enables early GPU initialization for flicker-free boot
#   - Without this, you'd see text console briefly before graphics
#
# Other modules to consider (not needed for this system):
#   - amdgpu: AMD Radeon GPUs
#   - nvidia/nouveau: NVIDIA GPUs
#   - usbhid: USB keyboard/mouse (if needed before hooks)
#   - xhci_hcd: USB 3.0 host controller
#
# Syntax: MODULES=(module1 module2 module3)
# ===========================================================================
MODULES=(i915)

# ===========================================================================
# BINARIES - ADDITIONAL BINARIES TO INCLUDE
# ===========================================================================
# Extra binaries copied into the initramfs CPIO archive.
# Useful for custom recovery scripts or specialized utilities.
# Dependencies are automatically resolved (libraries included).
#
# Note: Most binaries are added automatically by hooks.
# Only add here if you need something not provided by any hook.
#
# Examples:
#   - /usr/bin/vim: Editor for emergency recovery
#   - /usr/bin/btrfs: Btrfs filesystem tools (if not in hooks)
#
# Syntax: BINARIES=(binary1 binary2)
# ===========================================================================
BINARIES=()

# ===========================================================================
# FILES - ADDITIONAL FILES TO INCLUDE
# ===========================================================================
# Files copied into the initramfs exactly as-is (no dependency resolution).
# Critical for configuration files needed during early boot.
#
# /etc/cryptsetup.d/root.key:
#   - LUKS keyfile for automatic (passwordless) disk decryption
#   - 512-byte random binary file generated with: dd if=/dev/urandom
#   - Permissions MUST be 600 (root-only readable)
#   - This file enables booting without typing LUKS password
#
# Security Consideration:
#   The keyfile is embedded in /boot/initramfs-linux.img which is on an
#   unencrypted FAT32 /boot partition. Physical access to /boot could
#   potentially extract this keyfile. This is an acceptable trade-off for
#   convenience on a personal laptop with physical access control.
#
# Syntax: FILES=(file1 file2)
# ===========================================================================
FILES=(/etc/cryptsetup.d/root.key)

# ===========================================================================
# HOOKS - SCRIPTS THAT BUILD THE INITRAMFS
# ===========================================================================
# Hooks are the core of mkinitcpio. Each hook adds modules, binaries, and
# scripts to the initramfs. ORDER MATTERS - hooks are processed sequentially.
#
# Current Hook Chain (explained):
#
# 1. base
#    - Core utilities: busybox, kmod, kernel module tools
#    - REQUIRED for any functional initramfs
#
# 2. udev
#    - Device manager (udev daemon runs in initramfs)
#    - Handles hotplug events and device node creation
#    - Required for automatic module loading based on hardware detection
#
# 3. autodetect
#    - Scans running system to include only necessary modules
#    - Significantly reduces initramfs size (faster boot)
#    - Remove for "fallback" image that supports all hardware
#
# 4. modconf
#    - Includes /etc/modprobe.d/*.conf configuration files
#    - Ensures module options (e.g., iwlwifi power_save=0) are applied
#
# 5. block
#    - Block device drivers (NVMe, SATA, USB storage)
#    - Required to access root partition on any storage device
#
# 6. plymouth
#    - Boot splash screen support
#    - MUST come BEFORE 'encrypt' hook to display splash during decryption
#    - Requires plymouth package and configured theme
#
# 7. encrypt
#    - LUKS/dm-crypt disk decryption support
#    - Reads cryptdevice= and cryptkey= from kernel cmdline
#    - Creates /dev/mapper/cryptroot for decrypted root
#    - MUST come AFTER 'plymouth' for graphical password prompt (if used)
#
# 8. filesystems
#    - Filesystem drivers (ext4, btrfs, xfs, etc.)
#    - REQUIRED to mount root filesystem
#    - Btrfs support included for this system's root partition
#
# 9. keyboard
#    - Keyboard drivers for console input
#    - Required if LUKS prompts for password (not needed with keyfile)
#    - Kept for emergency recovery access
#
# 10. fsck
#     - Filesystem check utilities
#     - Runs fsck on root before mounting (if needed)
#     - Btrfs uses 'btrfs check' (lightweight, rarely needed)
#
# Hook Order Rationale:
#   - base/udev first: Core functionality
#   - autodetect/modconf: Module optimization
#   - block: Storage access
#   - plymouth: Splash screen BEFORE encryption prompt
#   - encrypt: Disk decryption
#   - filesystems: Mount support
#   - keyboard/fsck: Input and integrity checks
#
# Alternative Hook Sets (commented for reference):
# ===========================================================================
# Default Arch Linux (autodetect, no encryption):
# HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolefont block filesystems fsck)

# Full fallback (no autodetect, supports all hardware):
# HOOKS=(base udev microcode modconf block filesystems fsck)

# systemd-based initramfs (alternative to busybox/mkinitcpio):
# HOOKS=(base systemd autodetect microcode modconf kms keyboard sd-vconsole sd-encrypt block filesystems fsck)

# RAID + LVM + encryption combo:
# HOOKS=(base udev autodetect microcode modconf keyboard keymap consolefont block mdadm_udev encrypt lvm2 filesystems fsck)

# Current configuration (LUKS + Plymouth + Btrfs):
HOOKS=(base udev autodetect modconf block plymouth encrypt filesystems keyboard fsck)

# ===========================================================================
# COMPRESSION - INITRAMFS COMPRESSION METHOD
# ===========================================================================
# Controls how the initramfs CPIO archive is compressed.
# Affects boot time (decompression speed) and image size.
#
# Available options:
#   - zstd: Best balance of speed and compression (Linux ≥ 5.9 default)
#   - gzip: Traditional, widely supported, moderate compression
#   - xz: Maximum compression, slower decompression
#   - lz4: Fastest decompression, larger file size
#   - lzop: Fast, moderate compression
#   - cat: No compression (largest, fastest boot on fast storage)
#
# Recommendation: Use default (zstd on modern kernels) unless specific needs.
# ===========================================================================
#COMPRESSION="zstd"
#COMPRESSION="gzip"
#COMPRESSION="bzip2"
#COMPRESSION="lzma"
#COMPRESSION="xz"
#COMPRESSION="lzop"
#COMPRESSION="lz4"

# ===========================================================================
# COMPRESSION OPTIONS
# ===========================================================================
# Additional flags passed to the compression utility.
# Example for maximum zstd compression: COMPRESSION_OPTIONS=(-19)
# Example for maximum xz compression: COMPRESSION_OPTIONS=(-9e)
# ===========================================================================
#COMPRESSION_OPTIONS=()

# ===========================================================================
# MODULE DECOMPRESSION
# ===========================================================================
# MODULES_DECOMPRESS: Decompress kernel modules during initramfs creation.
#   - "yes": Decompresses .ko.zst/.ko.xz modules in initramfs
#            Increases RAM usage at boot, but allows higher compression
#   - "no": Keep modules compressed (default, lower RAM usage)
#
# Only enable if using high compression (-9e xz, --ultra zstd) and have RAM.
# ===========================================================================
#MODULES_DECOMPRESS="no"
